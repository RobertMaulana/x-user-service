#!/bin/bash

# Timestamp Function
timestamp() {
	date +"%T"
}

# Temporary file for stderr redirects
tmpfile=$(mktemp)

# Build a docker image
buildDocker() {
	echo "ğŸ‹	$(timestamp): building image user-service:latest"
	minikube tunnel
	eval $(minikube docker-env)
	docker build -t user-service:latest .
}

# Deploy to Minikube using kubectl
deploy() {
	echo "ğŸŒ§ï¸	 $(timestamp): deploying to Minikube"
	kubectl delete deployment user-service
	kubectl delete service user-svc
	kubectl apply -f deployment/deployment.yaml
}

# Orchestrate
if [[ $1 = "build" ]]; then
	if [[ $2 = "docker" ]]; then
		if [[ $3 = "deploy" ]]; then
			buildDocker
			deploy
		else
			buildDocker
		fi
		echo "âœ”ï¸	$(timestamp): complete."
		echo "ğŸ‘‹	$(timestamp): exiting..."
	elif [[ $2 = "bin" ]]; then
		build
		echo "âœ”ï¸	$(timestamp): complete."
		echo "ğŸ‘‹	$(timestamp): exiting..."
	else
		echo "ğŸ¤”   $(timestamp): missing build argument | do you already sign in to docker hub interactive shell?..."
	fi
else
	if [[ $1 = "--help" ]]; then
		echo "build - start a build to produce artifacts"
		echo "	docker - produces docker images"
		echo " 	bin - produces executable binaries"
	else
		echo "ğŸ¤”	$(timestamp): no arguments passed, type --help for a list of arguments"
	fi
fi
rm -f tmpfile